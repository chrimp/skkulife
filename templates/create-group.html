<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Group</title>
    <link rel="stylesheet" href="/html/static/css/style.css">
    <link rel="stylesheet" href="/html/static/css/group-info.css">
    <script src="/html/static/scripts/api.js" defer></script>
    {% include 'user-banner.html' %}
</head>
<body>
    <h2 class="banner">SKKULIFE</h2>
    <div class="wrapper">
        <div class="container">
            <div class="group-image-container">
                <img src="/html/static/images/default-group-image.svg" alt="모임 이미지" class="image">
                <input type="file" name="group-image" accept="image/jpeg, image/png, image/jpg" style="display: none;">
            </div>
            <!-- First Section -->
            <span class="subtitle">모임 이름</span>
            <input class="groupName" type="text" required>
            <span class="subtitle" value="placeholder">모임 소개문</span>
            <textarea name="description" required></textarea>
            <hr>

            <!-- Second Section -->
            <span class="subtitle">모임 요일</span>
            <div class="flexbox checkbox-container">
                <label><input type="checkbox" name="day" value="monday">월요일</label>
                <label><input type="checkbox" name="day" value="tuesday">화요일</label>
                <label><input type="checkbox" name="day" value="wednesday">수요일</label>
                <label><input type="checkbox" name="day" value="thursday">목요일</label>
                <label><input type="checkbox" name="day" value="friday">금요일</label>
                <label><input type="checkbox" name="day" value="saturday">토요일</label>
                <label><input type="checkbox" name="day" value="sunday">일요일</label>
            </div>
            <span class="subtitle">모임 시간</span>
            <div class="flexbox timebox">
                <input type="time" name="starttime">
                <span>-</span>
                <input type="time" name="endtime">
            </div>
            <span class="subtitle">투표 마감 시간</span>
            <div class="flexbox voteend">
                <span class="one">모임 마감</span>
                <div class="flexbox voteendtime">
                    <input type="text" value="placeholder">
                    <span class="two">이후</span>
                </div>
            </div>
            <span class="subtitle">인증 성공 퍼센트</span>
            <div class="flexbox percentage">
                <span class="spacer"></span>
                <input type="text" value="placeholder">
                <span class="text">% 이상</span>
            </div>
        </div>

        <div class="button-container">
            <button class="reactive-button update" onclick="postNewGroupInfo()">모임 생성</button>
        </div>
    </div>

    <script>
        function postNewGroupInfo() {
            const groupName = document.getElementsByClassName('groupName')[0].value;
            const description = document.getElementsByName('description')[0].value;
            const groupImage = document.getElementsByName('group-image')[0].value;
            
            // Fetch User Info for email
            const response = fetchWithToken('/user/info');
            const data = response.json();
            const email = data.email;

            const dayMap = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const days = Array.from(document.querySelectorAll('input[name="day"]:checked')).map(checkbox => dayMap[checkbox.value]);

            const startTime = document.getElementsByName('starttime')[0].value;
            const endTime = document.getElementsByName('endtime')[0].value;
            const voteEndTime = document.querySelector('.voteendtime input').value;
            const percentage = document.querySelector('.percentage input').value;

            const classCode = ("" + Math.random()).substring(2, 8);

            const formData = new FormData();
            formData.append('className', groupName);
            formData.append('manager', email);
            formData.append('classDescription', description);
            formData.append('classImage', groupImage);
            formData.append('classCode', classCode);
            formData.append('classDate', days);
            formData.append('classStartTime', startTime);
            formData.append('classEndTime', endTime);
            formData.append('voteEnd', voteEndTime);
            formData.append('votePercent', percentage);
            formData.append('penaltyType', 1);

            const createResponse = fetchWithToken('/class/create-class', {
                method: 'POST',
                header: {
                    'Content-Type': 'multipart/form-data'
                },
                body: formData
            });

            if (!createResponse.ok) {
                console.error('Error creating group', createResponse.status, createResponse.statusText);
                alert('모임 생성에 실패했습니다. 다시 시도해주세요.');
            } else {
                window.location.href = '/main'; // !! Add group id
            }
        }
    </script>
</body>
</html>