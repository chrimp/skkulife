<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Information</title>
    <link rel="stylesheet" href="/html/static/css/style.css">
    <link rel="stylesheet" href="/html/static/css/info.css">
    <script src="/html/static/scripts/api.js" defer></script>
    {% include 'user-banner.html' %}
</head>
<body>
    <h2 class="banner">SKKULIFE</h2>
    <div class="wrapper">
        <div class="container">
            <span class="title">계정 정보</span>
            <div class="user-info">
                <img class="icon" id="user-icon" alt="User Icon" src="/html/static/images/default-profile-image.svg">
                <span id="user-name"></span>
            </div>
            <!--
            <div class="change-username">
                <input title="new-username" type="text" id="new-username" value="{{ username }}"></input>
                <button type="button" onclick="changeUsername()">변경</button>
            </div>
            -->
            <hr>
            <span class="subtitle">이메일</span>
            <span id="user-email"></span>
            <hr>
            <span class="subtitle">가입된 모임</span>
            <div class="group-list"></div>
            <hr>
            <button class="new_group" onclick="location.href='/group-intro'">모임 추가</button>
        </div>

        <button class="delete-account" onclick="location.href='/deleteAccount'">계정 삭제</button>
    </div>
    
    <script>
        async function fetchUserInfo() {
            try {
                const response = await fetchWithToken('/user/info');
                const data = await response.json();
                document.getElementById('user-name').innerText = data.userName;
                document.getElementById('user-email').innerText = data.email;
                document.getElementById('user-icon').src = data.userImage;
                
                /*
                const imageByteString = data.userImage;
                const binaryString = new Uint8Array(imageByteString.length);
                for (let i = 0; i < imageByteString.length; i++) {
                    binaryString[i] = imageByteString.charCodeAt(i);
                }
                const blob = new Blob([binaryString], { type: 'image/*' });
                const imageUrl = URL.createObjectURL(blob);
                const userIcon = document.getElementById('user-icon');
                userIcon.src = imageUrl;

                const groupsInfoResponse = await fetch('/class/' + data.email);
                if (!groupsInfoResponse.ok) {
                    throw new Error("Error fetching groups info", groupsInfoResponse.status, groupsInfoResponse.statusText);
                }
                const groupsInfo = await groupsInfoResponse.json();

                const groupList = document.querySelector('group-list');
                groupList.innerHTML = '';
                groupsInfo.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'group';
                    groupDiv.innerHTML = `
                        <span class="groupName">${group.className}</span>
                        <button class="reactive-button" type="button" onclick="location.href='/main'">정보</button>
                        <button class="button" type="button" onclick="leaveGroup(${group.classId})">탈퇴</button>
                    `;
                    groupList.appendChild(groupDiv);
                });
                */

                const groupList = data.userClass;
                const groupListContainer = document.querySelector('.group-list');
                groupListContainer.innerHTML = '';
                groupList.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'group';
                    groupDiv.innerHTML = `
                        <span class="groupName">${group.className}</span>
                        <button class="reactive-button" type="button" onclick="setCurrentGroup(${group.classId})">정보</button>
                        <button class="button" type="button" onclick="leaveGroup(${group.classId})">탈퇴</button>
                    `;
                    groupListContainer.appendChild(groupDiv);
                });

            } catch (error) {
                console.error("Error fetching user info: ", error);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchUserInfo);

        function toggleNotifications() {
            const notificationCard = document.getElementById('notification-card');
            if (notificationCard.style.display === 'none' || notificationCard.style.display === '') {
                notificationCard.style.display = 'block';
            } else {
                notificationCard.style.display = 'none';
            }
        }

        function leaveGroup(classId) {
            fetch('/class/leave-class', {
                method: POST,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: {
                    "classId": classId
                }
            });

            fetchUserInfo();
        }
    
        function setCurrentGroup(classId) {
            sessionStorage.setItem('currentGroup', classId);
            window.location.href = '/main';
        }
    </script>
</body>
</html>