<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Info</title>
    <link rel="stylesheet" href="/html/static/css/style.css">
    <link rel="stylesheet" href="/html/static/css/group-info.css">
    <script src="/html/static/scripts/api.js" defer></script>
    {% include 'user-banner.html' %}
</head>
<body>
    <h2 class="banner">SKKULIFE</h2>
    <div class="wrapper">
        <div class="container">
            <!-- First Section -->
            <div class="group-image-container">
                <img src="/html/static/images/default-group-image.svg" id="class-image" alt="모임 이미지" class="image">
                <input type="file" name="group-image" accept="image/jpeg, image/png, image/jpg" style="display: none;">
            </div>
            <span class="subtitle">모임 이름</span>
            <input type="text" value="placeholder" required>
            <span class="subtitle" value="placeholder">모임 소개문</span>
            <textarea name="description" required>placeholder</textarea>
            <div class="flexbox invitecode">
                <span></span>
                <button onclick="copyToClipboard()">복사</button>
            </div>
            <hr>

            <!-- Second Section -->
            <span class="subtitle">모임 요일</span>
            <div class="flexbox checkbox-container">
                <label><input type="checkbox" name="day" value="monday">월요일</label>
                <label><input type="checkbox" name="day" value="tuesday">화요일</label>
                <label><input type="checkbox" name="day" value="wednesday">수요일</label>
                <label><input type="checkbox" name="day" value="thursday">목요일</label>
                <label><input type="checkbox" name="day" value="friday">금요일</label>
                <label><input type="checkbox" name="day" value="saturday">토요일</label>
                <label><input type="checkbox" name="day" value="sunday">일요일</label>
            </div>
            <span class="subtitle">모임 시간</span>
            <div class="flexbox timebox">
                <input type="time" name="starttime">
                <span>-</span>
                <input type="time" name="endtime">
            </div>
            <span class="subtitle">투표 마감 시간</span>
            <div class="flexbox voteend">
                <span class="one">모임 마감</span>
                <div class="flexbox voteendtime">
                    <input type="text" value="placeholder">
                    <span class="two">분 후</span>
                </div>
            </div>
            <span class="subtitle">인증 성공 퍼센트</span>
            <div class="flexbox percentage">
                <span class="spacer"></span>
                <input type="text" value="placeholder">
                <span class="text">% 이상</span>
            </div>
            <!--
            <span class="subtitle">벌칙 종류</span>
            <div class="flexbox">
                <div class="select-wrapper">
                    <select id="options">
                        <option value="option1">Option 1</option>
                        <option value="option2">Option 2</option>
                        <option value="option3">Option 3</option>
                    </select>
                </div>
            </div>
            -->
            <hr>

            <!-- Third Section -->
            <span class="subtitle">모임 멤버</span>
            <div id="group-members" class="flexbox userbox">
            </div>
        </div>

        <div class="button-container">
            <button class="reactive-button update" onclick="postNewGroupInfo()">수정하기</button>
            <button class="reactive-button delete">모임 삭제</button>
        </div>
    </div>

    <script>
        async function fetchGroupInfo() {
            var classId = sessionStorage.getItem('currentGroup');
            if (classId === null) {
                classId = '5a5bbe7d-2744-439b-86d2-e380342d6c91';
            }
            const response = await fetchWithToken('/class/' + classId);
            const dataArr = await response.json();
            const data = dataArr[0];

            const fetchedName = data.className;
            const fetchedDescription = data.classDescription;
            const fetchedCode = data.classCode;
            const fetchedImage = data.classImage;
            const fetchedDate = data.classDate;
            const fetchedStartTime = data.classStartTime;
            const fetchedEndTime = data.classEndTime;
            const fetchedVoteEnd = data.voteEnd;
            const fetchedVotePercent = data.votePercent;
            const fetchedMembers = data.classMember;

            document.getElementById('class-image').src = fetchedImage;
            document.querySelector('input[type="text"]').value = fetchedName;
            document.querySelector('textarea').value = fetchedDescription;
            document.querySelector('.invitecode span').innerText = fetchedCode;

            const dayMap = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            fetchedDate.forEach(day => {
                const dayName = dayMap[day];
                document.querySelector(`input[name="day"][value="${dayName}"]`).checked = true;
            });

            document.querySelector('input[name="starttime"]').value = fetchedStartTime;
            document.querySelector('input[name="endtime"]').value = fetchedEndTime;
            document.querySelector('.voteendtime input').value = fetchedVoteEnd;
            document.querySelector('.percentage input').value = fetchedVotePercent;

            const groupMembersContainer = document.getElementById('group-members');
            groupMembersContainer.innerHTML = '';
            fetchedMembers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flexbox userbox';
                userDiv.innerHTML = `
                    <span>${user.userName}</span>
                    <button class="reactive-button kick" style="display: none;">강퇴</button>
                `;
                groupMembersContainer.appendChild(userDiv);
            });

            await disableInputsIfNotManager(data);
        }

        async function postNewGroupInfo() {
            const groupName = document.getElementsByClassName('groupName')[0].value;
            const description = document.getElementsByName('description')[0].value;
            const classCode = document.querySelector('.invitecode span').innerText;
            
            // Fetch User Info for email
            const response = await fetchWithToken('/user/info');
            const data = await response.json();
            const email = data.email;

            const days = Array.from(document.querySelectorAll('input[name="day"]:checked')).map(checkbox => checkbox.value);

            const startTime = document.getElementsByName('starttime')[0].value;
            const endTime = document.getElementsByName('endtime')[0].value;
            const voteEndTime = document.querySelector('.voteendtime input').value;
            const percentage = document.querySelector('.percentage input').value;

            const formData = new FormData();
            formData.append('className', groupName);
            formData.append('manager', email);
            formData.append('classDescription', description);
            formData.append('classImage', groupImage);
            formData.append('classCode', classCode);
            formData.append('classDate', days);
            formData.append('classStartTime', startTime);
            formData.append('classEndTime', endTime);
            formData.append('voteEnd', voteEndTime);
            formData.append('votePercent', percentage);
            formData.append('penaltyType', 1);

            const createResponse = fetchWithToken('/class/create-class', {
                method: 'POST',
                headers: {
                    'Content-Type': 'multipart/form-data'
                },
                body: JSON.stringify(groupInfo)
            });

            if (!createResponse.ok) {
                console.error('Error creating group', createResponse.status, createResponse.statusText);
                alert('모임 정보 수정에 실패했습니다. 다시 시도해주세요.');
            } else {
                window.location.reload();
            }
        }

        function copyToClipboard() {
            const inviteCodeClass = document.getElementsByClassName('invitecode')[0];
            const inviteSpan = inviteCodeClass.querySelector('span').innerText;
            navigator.clipboard.writeText(inviteSpan).then(() => {
                alert('초대 코드가 복사되었습니다.');
            }
            ).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        async function disableInputsIfNotManager(data) {
            const userResponse = await fetchWithToken('/user/info');
            const userInfo = await userResponse.json();
            const userEmail = userInfo.email;

            if (data.manager != userEmail) {
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.disabled = true;
                });

                const buttonContainer = document.getElementsByClassName('button-container')[0];
                const buttons = buttonContainer.querySelectorAll('button');
                buttons.forEach(button => {
                    button.disabled = true;
                    button.style.display = 'none';
                });

                document.getElementById('class-image').style.cursor = 'default';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchGroupInfo);
    </script>
</body>
</html>